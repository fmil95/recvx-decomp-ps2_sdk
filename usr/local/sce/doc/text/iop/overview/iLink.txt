[SCEI CONFIDENTIAL DOCUMENT]
"PlayStation 2" Programmer Tool Runtime Library Release 2.0
                  Copyright (C) 2000 by Sony Computer Entertainment Inc.
                                                     All Rights Reserved

i.LINKドライバライブラリ
=========================


 1 ライブラリ概要
------------------


  1.1 概要

    i.LINKドライバライブラリは1394バスを監視する常駐ドライバとそれと通信
    を行なうための関数群から構成されています。これらはLINK層のすぐ上の階
    層に位置し、アプリケーションプログラマはこれを使って
         ・i.LINK常駐ドライバの各種パラメータの設定
         ・バスの制御と情報の取得
         ・イベント処理
         ・コールバック関数によるアシンクロナスリクエストパケットへの応答
         ・トランザクションコンテクストを使ったアシンクロナスリクエストパ
           ケットの送信
         ・コンフィグレーションROMへのアクセス
    等の基本的な操作を行なうことができます。
    
    i.LINKドライバライブラリの各関数はIOP側にのみインプリメントされていま
    す。EE上のプログラムから利用するためには必要な関数についてRPCクライア
    ント／サーバーを各自で実装する必要があります。
    
    

  1.2 関連ファイル

    i.LINKドライバライブラリを利用するために必要なファイルは次のとおりで
    す。
    
    +--------------+---------+
    |カテゴリ       ファイル |
    +              +         +
    |ヘッダファイル ilink.h  |
    |IOPモジュール  ilink.irx|
    +--------------+---------+

  1.3 参考資料

         ・1394規格全般について
           URL：http://www.1394ta.org/
         ・各規格の位置付けと概要について
           IEEE1394規格群の構成と各仕様の概要、インターフェース、2000年９
           月号、CQ出版社
         ・1394評価用ボードのためのWindows用ソフト開発について
           特集IEEE1394のハード＆ソフト入門、インターフェース、1999年７月
           号、CQ出版社
         ・PC（Windows）との接続について
           文書名：Plug and Play Design Specification for IEEE 1394 v. 
           1.0c
           入手先：http://www.microsoft.com/HWDEV/respec/pnpspecs.htm

  1.4 ハブ／リピータ／その他のデバイスとの接続について

    "PlayStation 2"と市販されている1394ハブ/リピータ/1394カード（PCを含む）
    などとの相互接続性については、未だ十分な検証が実施されておりません。i.
    LINKを使用するタイトルのパッケージやマニュアル等には「"PlayStation 2"
    以外の装置と接続すると、正常に動作しない場合がある」等の記載が必要で
    す。

  1.5 1394バスプロトコルアナライザについて

    1394バスプロトコルアナライザは1394バス上を流れる任意のパケットをトレ
    ース・解析し、また機種によってはパケットの送信もできる装置です。
    別項のソケットライブラリを使って"PlayStation 2"どうしで通信をする限り、
    特にアナライザが必要となることはありません。しかし、"PlayStation 2"以
    外のデバイスと通信を行うプログラムの開発に際しては、解析のためにアナ
    ライザが必要となる場合もあります。

 2 i.LINKドライバの仕様
------------------------


  2.1 ノードケイパビリティ

    i.LINKドライバ（ver 2.9）が提供するノードケイパビリティはトランザクシ
    ョンレベルです。
    すなわち次のレベルに位置します。
         (1) バスマネージャ（BM）：			×
         (2) アイソクロナスリソースマネージャ（IRM）：	×
         (3) アイソクロナス送受信：			×
         (4) トランザクション：				○
    
    なお、デフォルトでは機能しませんが、sce1394ConfSet()で
    SCE1394CF_NODE_CMCを指定するとサイクルマスタ（CM）capableとなります。
    ただし、アイソクロナス通信機能、IRM、共に実装していないため、
    "PlayStation 2"だけで構成されたネットワークにおいてはCM capableにして
    も意味がありません。

  2.2 制限事項

    i.LINKドライバ（ver 2.9）には以下の制限事項があります。
    
      リトライはsingle-phase retryのみに対応しています。（ハードウェアの
      仕様です）。
      force-rootでバスリセットする(ルートノードを変更する)ことはできませ
      ん。
      ルートノードを変更するためには、
         (1) sce1394SbPhyPacket()で PHYコンフィグレーションパケットを送信
             する
         (2) sce1394SbReset()でバスリセットする
      という手順が必要ですが、現在のところsce1394SbPhyPacket()が実装され
      ていないためです。

  2.3 コンフィグレーションROM

    デフォルトでi.LINKドライバが提供するコンフィグレーションROMの例を示し
    ます。
    
    
         (1) Chip_Id_Loには１台毎にユニークな識別番号が設定されます。
         (2) Model_Id, Model_Nameには"PlayStation 2"の機種名に応じたIDと文
             字列が設定されます。上記の例はSCPH-10000の場合です。
    

 3 使い方
----------


  3.1 通信の準備

    i.LINKドライバライブラリを使って通信を行なうための準備はおおよそ次の
    ようになります。
         (1) ドライバライブラリの初期化
             sce1394Initialize ()を用いてi.LINKドライバライブラリを初期化
             します。
         (2) Unit_Directoryの追加（必要に応じて）
             sce1394UnitAdd ()を用いてコンフィグレーションROMの
             Root_DirectoryにUnit_Directoryを追加します。追加される
             Unit_DirectoryのCRCはライブラリにより自動的に計算されます。
         (3) コールバック関数の登録（必要に応じて）
             sce1394TrDataInd()を用いて他ノードからのRead/Write/Lockリク
             エストに応えるためのコールバック関数を登録します。
         (4) イベント処理用スレッドの登録（必要に応じて）
             バスリセットの開始や終了、ある種のエラーなどは関数の戻り値で
             はなく、イベントとしてのみ検出可能です。このためこれらのイベ
             ントを検出したい場合にはイベント検出専用のスレッドを別に用意
             することになります。
         (5) バスへの接続
             すべての準備が整ったらsce1394SbEnable()を用いてパケットの送
             受信が可能な状態にします。パケットの送受信が可能な状態になっ
             たことを直ちに他ノードに認識させたい場合には、
             sce1394SbReset()を用いてバスリセットを発行します。

  3.2 トランザクションの発行

    i.LINKドライバライブラリではRead/Write/Lock等のリクエストはトランザク
    ションコンテクストを利用して発行します。そのための手順はおおよそ次の
    ようになります。
    
    ここで大切なことは「バスのgeneration numberがノードIDを取得した時点と
    トランザクションを発行する時点で同じでなければならない」ということで
    す。実装にあたってはこの点に注意してください。なお、sce1394TrRead()等
    は内部でトランザクションコンテクストのgeneration numberと最新の
    generation numberを比較して、一致するときだけトランザクションを発行す
    るようになっています。
    
         (1) トランザクションコンテクストの作成
             sce1394TrAlloc()を用いてトランザクションコンテクストを作成し
             ます。
         (2) generation numberの取得
             sce1394SbGenNumber()で現在のバスのgeneration numberを取得し
             ます。
         (3) 相手のノードIDの取得
             通信相手のノードIDを取得します。取得する方法はプロトコルによ
             って異なり、自分でバス上の全デバイスのコンフィグレーション
             ROMをスキャンする、相手が教えてくれる、などの場合があります。
         (4) トランザクションコンテクストの設定
             (1)で作成したトランザクションコンテクストにgeneration number
             と相手のノードIDを設定します。必要に応じて送信スピードや分割
             サイズも設定します。
         (5) トランザクションの発行
             sce1394TrRead()等を用いてトランザクションを発行します。これ
             らは通信処理が完了するまでブロックしますが、内部では
             WaitEventFlag()で待っているので、他のスレッドは実行すること
             ができます。
         (6) トランザクション完了後の処理
             sce1394Read()等の返り値に応じて以下のように分岐します。
          (a) ０以上：通信成功です。繰り返しsce1394TrRead()等を呼ぶことが
              できます。ただし、分割サイズを指定している場合は途中で起き
              たエラーによって要求と異なるサイズが返ることがあります。こ
              のときはsce1394TrStatus()でエラーの原因に関係する情報を取得
              できます。
          (b) SCE1394ERR_RESET_DETECTED：バスリセットによってバスの
              generation numberが変わり、コンテクストのバス情報が古くなっ
              ています。(2)からやり直す必要があります。
          (c) SCE1394ERR_FAILED_RESPONSE：相手からresp_complete以外の
              response-codeか、またはack_data_err, ack_type_err等が返って
              来ました。sce1394TrStatus()でresponse-codeが判ります。
              (ack_xxx_errは相当するresponse-code に変換されます)。
          (d) SCE1394ERR_ACK_MISSING：ackパケットを受信できませんでした。
          (e) SCE1394ERR_RETRY_LIMIT：ack_busyのリトライが制限回数を越えま
              した。
          (f) SCE1394ERR_TIMEOUT：時間内にレスポンスパケットが返って来ませ
              んでした。
          (g) SCE1394ERR_REQUEST_DISABLED：sce1394SbEnable()が呼ばれていま
              せん。
         (7) トランザクションコンテクストの解放
             不要になったトランザクションコンテクストはsce1394TrFree()を
             用いて解放します。
    

  3.3 終了処理

    すべての通信を完了し、i.LINKドライバの使用を止めるための手順は次のよ
    うになります。
         (1) sce1394SbDisable(1)を用いてパケットの送受信を禁止し、また外部
             からの要求に応答しないようにします。引数を１に指定することで
             「バスリセットの同時発行」を行ってください。
         (2) sce1394Destroy()を用いてドライバをリセットし、
             sce1394Initialize()で確保したリソースを解放します。

  3.4 リトライ

    ack_busyに対するリトライ回数はデフォルトでは０(リトライしない)になっ
    ています。
    これを変更したい場合はCSRのBUSY_TIMEOUTレジスタを書き換えてください。
    CSRの書き換えは、自ノードのCSRの読み出し・書き込みであってもRead/
    Writeトランザクションを発行することによって行います。
    また、バスリセットが起こるとBUSY_TIMEOUTレジスタはクリアされます。

  3.5 スレッドプライオリティの変更手順

    i.Linkが使用するスレッドプライオリティはHighとLowの2種類があります。
    デフォルト値は High = 28, Low = 34 となっています。
    
    スレッドプライオリティを上記のデフォルト値以外に設定したい場合は
    sceSifLoadModule()でilink.irxをロードする際に、第3引数で指定すること
    ができます。次に示すのは、High = 20, Low = 28と設定する例です。
    
        char* mes = "thpri=20,28";
        sceSifLoadModule( "host0:/usr/local/sce/iop/modules/ilink.irx", 
        strlen(mes)+1, mes );
    

 4 PCとの接続
--------------

    ここではWindows 98 Second Edition(SE)と接続する際に注意しなければなら
    ない事項について説明します。

  4.1 コンフィグレーションROM

    i.LINKドライバが提供するデフォルトのコンフィグレーションROMでは、
    Windows 98 SEは"PlayStation 2"を1394デバイスとして認識できません。
    Windowsから認識されるためにはRoot_Directoryに以下のエントリを持った
    Unit_Directoryを追加する必要があります。
    
    +----------------------+--------------+
    |key (hex)              value         |
    +                      +              +
    |Unit_Spec_Id (0x12)    0x080046（＊）|
    |Unit_Sw_Version (0x13) 0xFFFFFF（＊）|
    +----------------------+--------------+
    
    WindowsはUnit_Spec_IdとUnit_Sw_Versionの値から使用すべきドライバを判
    別します。
    "PlayStation 2"とPCを実験的に接続する限りにおいては上記の値を使用する
    ことができますが、Windowsとの接続を前提としたプログラムを商品化する場
    合には然るべき値を設定する必要があります。
