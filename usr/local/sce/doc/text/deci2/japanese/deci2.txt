[SCEI CONFIDENTIAL DOCUMENT]
"PlayStation 2" Programmer Tool Runtime Library Release 2.0
                  Copyright (C) 2000 by Sony Computer Entertainment Inc.
                                                     All Rights Reserved

DECI2 (ホスト ⇔ ターゲット間通信環境)
=======================================


 1 概要
--------

    このドキュメントは、ホスト上で動作する各種アプリケーションプログラム
    とターゲット上で動作するアプリケーションプログラムとの DECI2 プロトコ
    ルによる通信方法を概説し、DECI2 プロトコルを使用したアプリケーション
    を効率よく開発していただけるよう、プロトコルの特徴及びその背景となる
    コンセプトなどについて説明しています。
    
    ※このドキュメントの内容は99年5月現在の情報に基づいています。
      記載されている事項について今後変更される可能性がありますので、あら
    かじめご了承ください。
    
    ※このドキュメントでは、PCやワークステーションのことをホストと呼び、
    開発ツールハード
      ウェア(EB2000 など)のことをターゲットと呼ぶことにします。
    

 2 ホスト ⇔ ターゲット間通信
------------------------------

    DECI2 環境では、ホストとターゲット上の各プロセッサ間で一般的なデータ
    を送受信することができます。ホスト ⇔ ターゲット間の通信は、DECI2 プ
    ロトコルと上位プロトコルからなる DECI2 パケット" を単位として行われま
    す。以下にホスト ⇔ ターゲット間通信のブロックダイヤグラムを示します。
        図 1  ホスト ⇔ ターゲット間通信のブロックダイヤグラム

    "DECI2 Manager" は SCE が提供するモジュールで、ターゲット上の各プロセ
    ッサで動作し、ターゲット上のアプリケーションプログラムに API 関数を提
    供します。
    ターゲット上のアプリケーションプログラムは提供されている API 関数を使
    用してホストとの通信を行います。
    
    "protocol driver" とは、ターゲット上のアプリケーションプログラムまた
    はその一部のモジュールのことで、上位のプロトコルをハンドリングします。
    protocol driver は、ユーザーが自由に作成することができます。また、SCE
     があらかじめ提供しているものもあります。
    
    "dsnetm" は、SCE が提供するホスト上のアプリケーションプログラム群 
    "dsnet パッケージ" のなかのアプリケーションプログラムのひとつです。ホ
    スト上のアプリケーションはすべて、 dsnetm との TCP/IP ソケット間通信
    によってターゲットとの通信を行います。
    
    ホスト上のアプリケーションは、まず dsnetm とのコネクションを確立し、
    その上でターゲット上の protocol driver と通信を行います。ホスト上のア
    プリケーションはターゲット上の複数の protocol driver と通信することが
    可能です。たとえば、図 1 の(a)が(e)(f)と通信し、(b)が(c)(d)と通信する
    といったようなことができます。しかしながら、複数のアプリケーションが
    同時にひとつの protocol driver と通信することは基本的にはできません。
    たとえば、図 1 の(a)が(e)と通信している時に、(b)が(e)との通信を行うこ
    とはできません。

  2.1 DECI2 Manager

    ターゲット上の各プロセッサには、DECI2 Manager がひとつずつ存在します。
    DECI2 Manager と各種 protocol driver の関係は以下の図のようになります。
        図 2 DECI2 Manager と各種 protocol driver

    ここで "DBGP"、"TTYP"、"DRFP"、"DCMP" などは、SCE が提供している上位
    プロトコルの名称です。"DCMP"(DECI2 Control Message Protocol)は特別な
    プロトコルで、その protocol driver は DECI2 Manager の一部として実装
    されています。
    
    DECI2 Manager は、以下のような機能を提供します。
    
         ・各種 protocol driver の登録(MAX 16)、削除
         ・DECI2 パケットの送受信
         ・受信した DECI2 パケットの protocol driver への配送
         ・protocol driver からの DECI2 パケット送信要求への応答
         ・エラーイベントやステータスイベントの通知
         ・ホストとのコネクションの確立、ルート制御
         ・他の上位プロトコルのロック、ロック解除要求への応答
    
    他の上位プロトコルのロックとは、図 2 のようにターゲット上に複数の 
    protocol driver が存在する場合、ひとつの protocol driver が DECI2 
    Manager に対し、その protocol driver がハンドリングする上位プロトコル
    以外のすべての上位プロトコルの DECI2 パケットの送受信を拒否するように
    指示することをいいます。
    このロック機能は本来、デバッガがユーザープログラムの実行を停止してい
    る最中に DECI2 パケットの送受信を拒否しなければならないために存在して
    います。
    一般の protocol driver でもこの機能を使用することが可能ですが、その場
    合、デバッガからのプログラム停止コマンド等も受け付けなくなる可能性が
    あるので注意が必要です。
    

  2.2 dsnetm と dsnet パッケージ

    dsnet パッケージは、DECI2 環境でターゲットを操作するための、デバッガ、
    ドライバ、マネージャなどのアプリケーション群です。このドキュメントで
    は、dsnet パッケージに関する使い方などの説明は行いませんので、詳しく
    は dsnet.txt をご覧下さい。
    
    dsnetm は、ターゲットとホスト上のアプリケーションとの間に位置し、ター
    ゲットからの DECI2 パケットを各アプリケーションに配送し、またその逆を
    行う、ホスト上の DECI2 Manager プログラムで、 dsnet パッケージに含ま
    れています。
    
    ホスト上のアプリケーションはすべて dsnetm との TCP/IP ソケット間通信
    によってターゲットとの通信を行います。アプリケーションから dsnetm へ
    の指示は、dsnetm とアプリケーションとの間でのみ使用される "NETMP" と
    いう上位プロトコルを用いて行います。
    
    dsnetm は、以下のような機能を提供します。
    
         ・アプリケーションの登録、削除
         ・アプリケーションから指定された上位プロトコルの DECI2 パケットの
         ・配送要求への応答(受信配送要求のみ、送信は要求不要で常に許可)
         ・ターゲットのリセット
         ・ターゲットとのコネクションの確立、ルート制御
         ・エラーやステータスの通知
         ・ステータス情報管理
         ・指定された上位プロトコル番号を使用しているアプリケーションとの
           接続解除
         ・要求への応答
    

 3 DECI2 プロトコル
--------------------

    DECI2 プロトコルは、ホストとターゲット上の各プロセッサ間で一般的なデ
    ータを送受信するためのプロトコルです。DECI2 プロトコルは、上位プロト
    コルと組み合わせて使用されることを想定しています。プログラマが自由に
    上位プロトコルを定義し、そのプロトコルを扱うアプリケーションをホスト
    上とターゲット上で作成することで通信を行うことができます。以下の図は、
    DECI2 プロトコルと上位プロトコルとの関係を示したものです。
        図 3 DECI2 プロトコル階層


  3.1 DECI2 プロトコルの特徴

    DECI2 プロトコルでは、プロトコルヘッダの source/destination フィール
    ドにホストや各プロセッサを表す "node ID" を指定することによって、 
    DECI2 パケットを source node からdestination node に送信することがで
    きます。
    
    DECI2 プロトコルは、非常にシンプルで自由度の高いプロトコルですが、そ
    れ故に限られた機能しか持っていません。それは上記のアドレッシングだけ
    であり、フラグメンテーション、フローコントロール、シーケンシングなど
    は一切行いません。
    また、インオーダーは保証しますが、チェックサムなどのエラー検出系はな
    く unreliable です。ただし、DCMP(DECI2 Control Message Protocol) を併
    用することによって reliable な通信を行うことができます。

  3.2 ヘッダフォーマット

    DECI2 プロトコルのヘッダフォーマットは、リトルエンディアンで以下のよ
    うになります。このヘッダを、DECI2 Manager や dsnetm が生成することは
    ありません。
    アプリケーションや protocol driver が生成して、DECI2 Manager や 
    dsnetm に渡す必要があります。
        図 4 DECI2 プロトコルヘッダフォーマット

    Length は、DECI2 プロトコルヘッダを含むパケット全体の長さをバイト単位
    で表します。パケットの最大長は 64kbytes です。
    
    Protocol は、上位プロトコルの番号を表します。プロトコル番号は、SCE、
    ツールメーカー、ローカルユースなどで以下のように割り当てます。
    
      0x0000		: reserved(使用不可)
      0x0001		 : DCMP
      0x0002 - 0x0fff	: SCE use
      0x1000 - 0xdfff	: Tool licensee use
      0xe000 - 0xefff	: local use for licensee
      0xf000 - 0xffff	: reserved
    
    Source、Destination は、DECI2 パケットの送信元、送信先を以下の node 
    ID で表します。特別なケースとして、dsnetm からホスト上のアプリケーシ
    ョンへ直接送信されるパケットは送信元、送信先がどちらも 'H' になります。
    同様に、DECI2 Manager からプロトコルドライバへのパケットは送信元、送
    信先がどちらも 'E' や 'I' になります。
    
      I(0x49): IOP
      E(0x45): EE
      H(0x48): HOST
    

 4 SCE が定義している上位プロトコル
------------------------------------

    SCE が定義している上位プロトコルには、以下のようなものがあります。
    これらの詳細については、それぞれのドキュメントを参照してください。
    
    DCMP : DECI2 Control Message Protocol
    NETMP: DECI2 Net Manager Protocol
    DBGP : DECI2 Debug Protocol
    DRFP : DECI2 Remote File Protocol
    TTYP : DECI2 Tty Protocol
    

 5 アプリケーションの作成
--------------------------

    DECI2 プロトコルをアプリケーションで利用する際に、大きくわけて以下の
    二つのタイプが考えられます。
    
          (a) SCE が定義している上位プロトコルのみを使用する、ホスト上のア
              プリケーションを作成する
          (b) 新たに上位プロトコルを定義して、ホスト上とターゲット上の両方
              でアプリケーションを作成する
    (a) のタイプのアプリケーションを作成する場合は、使用したい上位プロト
    コルの他に、DCMP、NETMP について理解しておく必要があります。
    
    (b) のタイプのアプリケーションを作成する場合には、上記に加えてターゲ
    ット上の DECI2 API を理解しておく必要があります。DECI2 API に関しては、
    libd2_j.txt を参照してください。
    
    ホストと EE の間で大きなデータの通信をする場合は、まずホストと IOP の
    間で DECI2 プロトコルによる通信をおこない、IOP と EE の間では通常の 
    DMA 転送を使用する方がより早い通信を行うことができます。
    
    DECI2 プロトコルを用いて EE と IOP 間の通信を行うことは可能ですが、通
    常の DMA 転送を使用してください。転送速度も速いですし、実機では DECI2
     Manager が実装されていない可能性もあります。
