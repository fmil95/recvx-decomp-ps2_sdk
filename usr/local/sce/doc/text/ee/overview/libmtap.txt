[SCEI CONFIDENTIAL DOCUMENT]
"PlayStation 2" Programmer Tool Runtime Library Release 2.0
                  Copyright (C) 2000 by Sony Computer Entertainment Inc.
                                                     All Rights Reserved

マルチタップライブラリ
=======================

    

 1 ライブラリ概要
------------------


  1.1 概要

    libmtapは"PlayStation 2"専用マルチタップを制御するためのライブラリで
    す。libmtapとコントローラライブラリまたはメモリーカードライブラリを一
    緒に使用することで、"PlayStation 2"用マルチタップに接続されたコントロ
    ーラおよびメモリーカードと通信を行うことができます。

  1.2 関連ファイル

    libmtapに必要なファイルは次のとおりです。
    
    +------------------+----------------------------------+
    |カテゴリ           ファイル名                        |
    +                  +                                  +
    |ライブラリファイル libmtap.a                         |
    |ヘッダファイル     libmtap.h                         |
    |モジュールファイル mtapman.irx                       |
    |                   sio2man.irx                       |
    |                   padman.irx, mcman.irx, mcserv.irx |
    +------------------+----------------------------------+
    
    libmtapはEE用ライブラリとIOP用モジュールとで構成されています。libmtap
    を使用する場合はEE側プログラムでsceSifLoadModule()を用いて、
    mtapman.irxをロードしてください。このとき、他の関連モジュールとのロー
    ド順序に注意が必要です。詳しくは後述します。
    また、EE用ライブラリをリンクするために、各Makefileでリンクオプション
    に-lmtapを追加してください。

 2 使用手順
------------


  2.1 ポートとスロット

    マルチタップを介して接続されたコントローラ / メモリーカードにアクセス
    するためには、libpad / libmcの各関数でportとslotの2つの引数によって、
    対象のコントローラ / メモリーカードを指定します。portは"PlayStation 
    2"本体のコントローラ端子 / メモリーカード差込口を、slotはマルチタップ
    のコントローラ端子 / メモリーカード差込口を指定する引数です。
    本体に直接接続されたコントローラ / メモリーカードにアクセスするときは、
    portに適切なポート番号を指定し、slotには0を指定します。マルチタップを
    介して接続されたコントローラ / メモリーカードにアクセスするときは、
    portとslotをそれぞれ適切に指定します。次の例を参照してください。
    
    

  2.2 IOP用モジュールの依存関係とロード順序

    コントローラおよびメモリーカードの通信に関連するIOP用モジュールとして
    は、sio2man.irx / padman.irx / mcman.irx / mcserv.irx、そして
    mtapman.irxがあります。
    padman.irx / mcman.irx / mcserv.irxはマルチタップ上のデバイスと通信す
    るためにmtapman.irxの機能を使用しますが、直接mtapman.irxを参照するの
    ではなくsio2man.irxを経由して間接的に参照します。mtapman.irxがロード
    されていない場合でも、これらのモジュールは処理に破綻をきたしません。
    
    
    したがって、マルチタップに対応しないアプリケーションではmtapman.irxを
    ロードする必要はありません。
    マルチタップに対応するアプリケーションでは、上記の各モジュールを次の
    順序でロードする必要があります。
         (1) sio2man.irx
         (2) mtapman.irx
         (3) padman.irx および mcman.irx / mcserv.irx
    padman.irxとmcman.irx / mcserv.irxのロード順序は問いません。mcman.irx
    とmcserv.irxのロード順序はメモリーカードライブラリのドキュメントに従
    ってください。

  2.3 ライブラリの使用手順

    libmtapとlibpad / libmcとを使用して、マルチタップに接続されたコントロ
    ーラやメモリカードにアクセスする手順は次のようになります。

   (1) libmtapの初期化

      sceMtapInit()を呼び出して、マルチタップライブラリを初期化します。

   (2) libpad / libmcの初期化

      コントローラライブラリ / メモリーカードライブラリをそれぞれ初期化し
      ます。

   (3) マルチタップポートのオープン

      sceMtapPortOpen()を呼び出して、マルチタップが接続されているはずのポ
      ートをオープンします。オープンしたポートに対しては1フレームに1回、
      マルチタップが接続されているかどうかの確認が行われるようになります。

   (4) スロット数の確認

      コントローラライブラリの関数scePadGetSlotMax()を用いて、オープンし
      たポートに接続されているマルチタップのスロット数を確認します。

   (5) コントローラポートのオープン / メモリーカードの状態確認

      scePadPortOpen()を呼び出してコントローラとの通信を開始します。
      メモリーカードに対してはsceMcGetInfo()を呼び出してメモリーカードの
      接続状態を確認します。

  2.4 スレッドプライオリティの変更

    IOPのマルチタップドライバmtapman.irxのスレッドプライオリティを変更す
    ることができます。変更方法は
         (1) モジュールロード時に指定する
         (2) 実行中に変更する
    の２通りあります。
    モジュールロード時に指定するには、sceSifLoadModule()の引数にプライオ
    リティを指定します。mtapman.irxのモジュールプライオリティは2つあり、
    最初に指定するのがメインスレッドプライオリティ、2番目に指定するのが
    SIFインターフェイスモジュールのプライオリティです。モジュールロード時
    の引数の記述は、
        char arg[] = "thpri=20,46";
        sceSifLoadModule( "host0:/usr/local/sce/iop/modules/mtapman.irx",
        					  strlen( arg ) + 1, arg );
    などと指定してください。
    
    実行中に変更するには、sceMtapChangeThreadPrioriry()を呼び出します。こ
    の場合2つのモジュールプライオリティを同時に変更します。詳しくは関数リ
    ファレンスを参照してください。

 3 注意事項
------------


  3.1 ポートオープンとシステムの負荷

    sceMtapPortOpen()でオープンしたポートにマルチタップが接続されていない
    場合、接続確認のために通信処理がタイムアウトするまでの時間がかかるこ
    とになります。通信処理はIOPの負荷とはなりませんが、シリアルI/Fを占有
    するため他のコントローラやメモリーカードとの通信処理に影響を与えます。
    タイミングの関係で、コントローラに対してはごくわずかしか影響がありま
    せんが、メモリーカードに対しては、シリアルI/Fの空き時間が短くなる分だ
    けダイレクトに影響が現れます。メモリーカードのアクセスを高速に行うた
    めには、マルチタップが接続されていないポートを閉じるようにしてくださ
    い。

  3.2 RPC再入に関する注意

    libmtapのすべての関数はsceSifBindRpc() / sceSifCallRpc()をWAIT実行し
    ます。そのため、複数のスレッドで利用する場合はRPC再入を起さないように
    注意が必要です。また、割り込み禁止状態や割り込みハンドラ内で呼び出さ
    ないようにしてください。
    RPC再入については「SIFシステム」ドキュメントに解説がありますので参照
    してください。
