[SCEI CONFIDENTIAL DOCUMENT]
"PlayStation 2" Programmer Tool Runtime Library Release 2.0
                  Copyright (C) 2000 by Sony Computer Entertainment Inc.
                                                     All Rights Reserved

MPEGライブラリ
===============


 1 ライブラリ概要
------------------


  1.1 概要

    libmpegはMPEG2 / MPEG1画像のデコードを行うライブラリです。対応する
    MPEG2(MPEG1)ストリームは以下のとおりです。
      Main Profile at Main Level(MP@ML)
      Simple Profile at Main Level(SP@ML)
      サイズ :	最小32x32、最大720x480　高さおよび幅（ピクセル数）は16の倍
      数
      ピクチャ構造 :	フレーム構造（プログレッシブフレームが望ましい）

  1.2 関連ファイル

    libmpegを利用する際に必要なファイルは次のとおりです。libmpegは内部で
    libipuを使用しますので、libipuのライブラリファイルも必要となります。
    
    +------------------+----------+
    |カテゴリ           ファイル名|
    +                  +          +
    |ライブラリファイル libmpeg.a |
    |                   libipu.a  |
    |ヘッダファイル     libmpeg.h |
    +------------------+----------+

  1.3 使用リソース

    libmpegはデコード処理に際して、メインメモリ以外に次のハードウェアリソ
    ースを使用します。
    
    +--------------+----------------------------------+
    |リソース       使用期間                          |
    +              +                                  +
    |DMA ch4        全体を通じて                      |
    |DMA ch3        sceMpegInit(),                    |
    |               sceMpegGetPicture(),              |
    |               sceMpegGetPictureRAW8()の中でのみ |
    |ScratchPad RAM sceMpegGetPicture(),              |
    |               sceMpegGetPictureRAW8()の中でのみ |
    +--------------+----------------------------------+
    
    libmpegが使用する期間、これらのリソースが他で使われないように注意して
    ください。

  1.4 サンプルプログラム

    libmpegを利用したサンプルには以下のものがあります。
         (1) sce/ee/sample/mpeg/ezmpeg
             メインメモリ上のMPEG2 ビデオエレメンタリストリーム(m2v)を再
             生します。
         (2) sce/ee/sample/mpeg/mpegstr
             CD/DVD/ホスト上のハードディスクにある MPEG2 ストリーム(PSS)
             を再生します。
             色変換にはIPUを使用します。
         (3) sce/ee/sample/mpeg/mpegvu1
             CD/DVD/ホスト上のハードディスクにある MPEG2 ストリーム(PSS)
             を再生します。
             色変換にはVU1を使用します。

  1.5 制限および注意事項

         ・sceMpeg構造体はプログラム全体でひとつしか生成できません。複数生
           成した場合の動作は保証されません。
         ・現在のバージョンでは、タイムスタンプPTS / DTSの参照する時計（
           STC）機能はサポートされていません。PSSに記録された PTS / DTSを
           取得することだけが可能です。
    

 2 機能の特徴
--------------


  2.1 ストリームの非多重化

    libmpegには、多重化されたMPEG2 Program Streamを非多重化して、映像・音
    声・その他のデータといった要素ストリーム（elementary stream）を取り出
    す機能があります。
    
    
    ストリームの構造は次のようになっています。

    多重化ストリーム

      PSS（PlayStation Stream）：PlayStation用音声/データ付MPEG2 Program 
      Stream
      PSS：（MPEG2 video）+（ADS）+（DATA）
      PSS中の各ストリームはストリームタイプとストリーム番号で特定される。
      音声/データはMPEG2プライベートストリームとして記録される。

    要素ストリーム

      映像：MPEG2 video　拡張子m2v等、標準のMPEG2 video stream
      音声：ADS（Audio Data Stream）　PS2用のストリーミング音声
      	(a) PCM形式	ストレートPCM 16bit 48KHz 2ch
      	(b) ADPCM形式	SPU2用ADPCM（VAGと同じ）
      データ：任意データ
    
    PSS との比較のために、DVDのストリーム構造を次に示します。

    多重化ストリーム

      DVDストリーム(vob)：DVD用音声/サブピクチャ付MPEG2 Program Stream
      DVDストリーム(vob)：（MPEG2 video）+（DVD用音声）+（サブピクチャ）
      ……
      （MPEG2 audio以外の）音声 / サブピクチャは、MPEG2プライベートストリ
      ームとして記録される。

    要素ストリーム

      映像：MPEG2 video
      音声：MPEG2 audio / Dolby AC3 / PCM / DTS / SDDS
      サブピクチャ：データ（字幕等）

  2.2 コールバックメカニズム

    libmpegは、連続的なデータのデコード処理（ストリーミング）を実現します。
    "PlayStation 2"でこのような処理を行うときIOP / EE上のさまざまな段階で
    バッファリングが必要になります。バッファリングの実装方式はさまざまに
    考えられるため、libmpegでは特定のバッファリング方式を想定しません。バ
    ッファリングの方式は、アプリケーション側が自由に設定することができま
    す。バッファを管理するアプリケーション側とlibmegの処理とを協調動作さ
    せるために、libmpegはコールバックのメカニズムを持ちます。
    コールバックは、libmpeg側の処理において特定の事象が起こったときに、前
    もって登録されたアプリケーション側の関数（コールバック関数）が呼び出
    されるしくみです。libmpegがサポートしているコールバックタイプと要因は
    次のとおりです。
    
    +-------------------+--------------------------------------------+
    |コールバックタイプ  要因                                        |
    +                   +                                            +
    |sceMpegCbError      デコードエラーが発生した                    |
    |sceMpegCbNodata     入力データがなくなった                      |
    |sceMpegCbStopDMA    IPUへのDMA転送をアプリケーションが中断する  |
    |                    必要がある                                  |
    |sceMpegCbRestartDMA IPUへのDMA転送をアプリケーションが再開する  |
    |                    必要がある                                  |
    |sceMpegCbBackground IPUでCSC処理が開始された                    |
    |sceMpegCbTimeStamp  デコード中のデータに対応するtime stampが必要|
    |sceMpegCbStr        目的のストリームデータを見つけた            |
    +-------------------+--------------------------------------------+
    
    コールバック関数に渡される引数やコールバック関数の戻り値は、コールバ
    ックタイプによってそれぞれ異なります。詳細はリファレンスドキュメント
    で、各コールバックに対して定義されている構造体の解説を参照してくださ
    い。
    以下、各コールバックタイプについて説明します。

    sceMpegCbError

      デコード処理でエラーが発生したときに発生するコールバックです。コー
      ルバック関数が登録されていなければ、エラーメッセージが端末に出力さ
      れます。

    sceMpegCbNodata

      デコード中に入力データがなくなった場合に発生するコールバックです。
      アプリケーション側はこれを受けて、DMA ch4でIPUへ新たなデータを送る
      必要があります。

    sceMpegCbStopDMA

      CSC処理のためにDMA ch4を中断する必要があるとき発生するコールバック
      です。
      MPEG2 Streamのデコードを行う場合、ビットストリームのデコードとCSC（
      色変換）を別に行うため、1枚のピクチャに対してIPUを2回使用します。ビ
      ットストリームデコードのためのDMA転送はアプリケーション側が管理しま
      すが、CSCのためのDMA転送はデコーダ側（libmpeg内部）で管理されて自動
      的に行われるようになっています。このため、デコーダがCSCを行う際には
      このコールバックを発生することによって、アプリケーション側にDMA ch4
      をいったん中断するように要求します。アプリケーション側はこれを受け
      てDMA ch4をいったん中止し、そのときのデコード位置を保存しておく必要
      があります。

    sceMpegCbRestartDMA

      デコーダがCSC処理を終え、次のビットストリーム入力を待つ際に発生する
      コールバックです。アプリケーション側はこれを受けてDMA ch4を再開し、
      sceMpegCbStopDMAの際に保存しておいたデコード位置以降のデータをIPUに
      送る必要があります。

    sceMpegCbBackground

      デコーダがCSC処理を開始したときに発生するコールバックです。CSC処理
      中はデコード処理の負荷がEE coreにかからなくなりますので、これを受け
      てアプリケーション側は適当なバックグラウンド処理を実行することがで
      きます。このバックグラウンド処理でIPUおよびDMA ch3,4を使うことはで
      きませんので注意してください。

    sceMpegCbTimeStamp

      デコーダがピクチャの先頭を見つけたときに発生するコールバックです。
      これを受けてアプリケーションは、D4_MADR, IPU_CTRL, IPU_BPを調べてデ
      コード位置を特定し、それに関連するPTS / DTSをデコーダに提供する必要
      があります。

    sceMpegCbStr

      PSSの非多重化処理に際して、デコーダが特定の要素ストリームデータを見
      つけたときに発生するコールバックです。これを受けてアプリケーション
      側では、見つかった要素ストリームに応じた適切な処理を行います。
      他のコールバックタイプではコールバック関数はそれぞれひとつだけしか
      登録できませんが、sceMpegCbStrでは要素ストリームごとにひとつずつの
      コールバック関数を登録することができます。要素ストリームは、ストリ
      ームタイプとストリーム番号によって区別します。ストリームタイプとス
      トリーム番号の有効範囲を次に示します。
      
    +------------------+----------------+--------------+
    |要素ストリーム     ストリームタイプ ストリーム番号|
    +                  +                +              +
    |MPEG2 video stream sceMpegStrM2V    0-15          |
    |IPU stream         sceMpegStrIPU    0-65535       |
    |PCM stream         sceMpegStrPCM    0-65535       |
    |ADPCM stream       sceMpegStrADPCM  0-65535       |
    |DATA stream        sceMpegStrDATA   0-65535       |
    +------------------+----------------+--------------+
      
