[SCEI CONFIDENTIAL DOCUMENT]
"PlayStation 2" Programmer Tool Runtime Library Release 2.0
                Copyright (C) 2000 by Sony Computer Entertainment Inc.
                                                   All Rights Reserved
                                                             Aug. 2000

----------------------------------------------------------------------
ハードウェアのリビジョンに関する注意事項
----------------------------------------------------------------------
DTL-T10000, DTL-H10000, 及び実機 SCPH-10000 に搭載されている EE, GS の
チップには以下のような制限事項があります。以下の機能の使用にあたっては
ご注意ください。

	EE : Revision 2.9
	GS : Revision 8.0

なお、最新情報につきましては SCE-NET をご参照いただけますようお願い致
します。
----------------------------------------------------------------------
* EE(Rev 2.9)における制限事項
----------------------------------------------------------------------
1. デバッグ機能（ハードウェアブレークポイント等）に関して

    以下のような不明確な点および制限があります。

    - ハードウェアブレークポイントの data value break point および
      パフォーマンスカウンタは、厳密には正確な Program Counter の位置
      で停止しません。

    - sync 命令にハードウェアブレークポイントの address break point を
      設定した場合、正常に動作しない場合があります。また、data value
      break point では、設定した条件にマッチしていない場合でも、
      ハードウェアブレーク例外が発生することがあります。

2. MFIFO の Drain Channel の設定に関して

    MFIFO の Drain Channel の DMA が動作している途中で MFIFO のリング
    バッファアドレスを変更すると、動作が不安定になることがあります。
    Drain Channel の転送中にリングバッファアドレスを変更することはお控
    えください。

3. VPU の SQ 命令に関して

    任意の upper 命令と SQ命令(lower 命令)の組合せで、upper 側の
    floating destination register 番号(fd)と SQ 命令の integer source 
    register(it)番号が同じ場合に、レジスタの依存関係があると誤認し、
    余分なストールが発生します。SQI, LQI, SQD, LQD 命令では発生しません。

    [例]
	3サイクルのストールが発生する例
	ADD.x VF03, VF04, VF07		NOP
	NOP				SQ VF08, 0(VI03)

	ストールが発生しない例
	ADD.x VF03, VF04, VF07		NOP
	NOP				SQI VF08, VI03

4. VIF の DMAtag mismatch error について
 
    VIFn_ERR.ME0 = 0 (DMAtag mismatch error mask disable) を設定してい
    ると、正しいパケットが VIF へ送信されているにもかかわらず、
    DMA mismatch error 割り込みが発生することがあります。
    
    [回避策]
	VIFn_ERR.ME0 = 1 にしてご使用下さい。


5. DMAC ch1, ch9 の同時転送に関して

    toSPR のソースチェインモードと toVPU1 のソースチェインモードを同時
    に実行し、かつ toSPR の TTE = 0 で、かつ toVPU1 の TTE = 1の場合、
    転送がストールする可能性があります。

    [回避策]
	上記の条件の DMA を同時に起動しないようにしてください。

6. COP1(FPU),COP2(VU0) の除算系命令に関して

    EE 内部の FDIV（浮動小数点除算器）の動作不良のため以下の不具合が
    発生します。

    COP1(FPU) の除算系命令    DIV.S, SQRT.S, RSQRT.S
    COP2(VU0) の除算系命令    DIV, SQRT, RSQRT, VDIV, VSQRT, VRSQRT
    において、まれに間違った値が返る事があります。

    [回避策]
    以下に挙げる箇所に、除算系命令を配置しない事で回避できます。

       1. 分岐命令の分岐先２命令
       2. 分岐命令の後ろ３命令（分岐遅延スロットを含む）
       3. SYNC.P の直後１命令
       4. VU0 マイクロコードの先頭２命令

    [ソフトウェアでの対応]
      C/C++ のプログラムの場合：
      ハードウェアの不具合を回避するコードを生成するように、GNUツールを
      修正する事で対応を進めております。

      アセンブラの場合：
      プログラミング上の制約事項となりますので、上に挙げた回避策を取って
      下さい。

7. DMAC の初期設定に関して

    ノーマルモード・インターリーブモードを用いて DMA 転送を行なう場合
    Dn_QWC = 0 を 0 にした状態で DMA をキック (Dn_CHCR.STR =1 に設定)
    した場合には、正しい転送が行なわれません。
    すなわち

    // 以下のコードは正常に動作しません
    // （条件によって動作が不定になります）

    // Normal Mode の場合
    Dn_CHCR.MOD = 0;	// Normal Mode
    Dn_QWC      = 0;	// 転送ワード数 = 0
    Dn_CHCR.STR = 1;	// DMA 転送開始

    // Interleavel Mode の場合
    Dn_CHCR.MOD = 2;	// Interleave Mode
    Dn_QWC      = 0;	// 転送ワード数 = 0
    Dn_CHCR.STR = 1;	// DMA 転送開始

    [回避策]
    Dn_QWC = 0 に設定した状態で DMA を起動しないようにして下さい。

    この制限は、最終仕様版にも存在します。

8. 5命令以下のショートループに関して

     5 命令以下（分岐命令を含めて 6 命令以下）の非常に短いループでは、
     分岐予測を誤る可能性があります。
     例えば以下のループで、l0-a, l1-a, l0-b, l1-b にハザード
    （キャッシュミスなどによる「待ち」のサイクルが発生すること）が
     ない場合で、まれに分岐条件を間違えます。

     label:    l0-a			// l0 パイプの命令
	       l1-a			// l1 パイプの命令
	       l0-b			// l0 パイプの命令
	       l1-b			// l1 パイプの命令
	       branch taget=label	// label 番地への分岐
	       l1-c			// l1 パイプの命令

     具体例
               addiu	$a1,$a1,1
	       addiu	$v1,$v1,4
	       addu	$s0,$s0,$a1
	       slti	$v0,$a1,80
	       bnez	$v0,20 <c+0x20>
	       sw	$s0,0($v1)
    
    [回避策]
      C/C++ のプログラムの場合：
      Release 1.3にて、条件分岐命令の直前に必要に応じて適切な数の nop 
      を追加するように ee-as を修正しました。

      アセンブラの場合：
      ５命令以下（分岐命令を含めて６命令：分岐遅延スロットを含む）の
      ループは使用しないで下さい。

9. メインメモリ空間にマップされたVU-MEMのアクセスに関して

    メインメモリ空間にマップされたVU-MEMをEE-COREからアクセスできる機
    能はあくまでもデバッグ用途の為、VUの動作中のアクセスは動作保証があ
    りません。

    例えば、EE-COREのstore命令でVU-MEMにデータを書き込んだ直後に、VUマ
    クロ命令(cop2命令)でその値を使用する場合、store命令はwrite-buffer
    を介して書き込みを行うため、マクロ命令発行時までに書き込みが終了す
    る保証がありません。その場合、VUが動作中(マクロ命令)にアクセスする
    ことになりますので誤動作することがあります。
    この問題は、store命令とマクロ命令の間にsync.l命令を挿入することで
    回避できます。

----------------------------------------------------------------------
* GS(Rev 8.0)における制限事項
----------------------------------------------------------------------
1. デプステストに関して

    デプステストの制御を行うZTEのON/OFFを切り替えると、条件によっては正
    しくテストが行われない場合があります。

    このためデプステストを行わない場合またはZバッファを使用しない場合は
    ZTE=0とせずに、ZTE=1,ZTST=01(Always)かつZBUFレジスタのZMSK=1と設定
    してください。このときのGSの内部動作はZTE=0と設定した場合と等価にな
    ります。

2. GSからEEへの割り込み処理に関して

    GSからEEへの割り込み要因の種類として、SIGNAL、FINISH、HSync、VSync
    がありますが、GS割り込みに対する割り込みハンドラ処理中に別なGS割り
    込みが発生した場合、割り込みハンドラの記述次第で、2つ目以降の割り
    込みをEE側がとりそこねることがあります。

    [回避策]
    GS割り込みのハンドラ中で、一旦GSの割り込みマスクレジスタをマス
    ク状態にしていただければ、上記の症状を防ぐことができます。
    
	u_long UserIMR;

	// 全割り込みをマスク
	UserIMR = sceGsPutIMR(0xff00);

	// 割り込み要因の種別による分岐

	// 割り込み要因のクリア

	// 割り込みに対応する処理

	// 割り込みマスクの解除
	sceGsPutIMR(UserIMR);

    なお、V-Blankの開始、終了割り込みに関しましては、上記GS割り込みと
    は別の割り込みとしてEEに入力されますので、上記対処は必要ありません。

3. テクスチャの横幅について

    GS ローカルメモリーへのテクスチャ転送に際しまして、使用されるテクセル
    フォーマットに応じて設けられている、テクスチャの横幅に対する制限を拡張
    させていただきます。

          テクセルフォーマット  　　         テクスチャの横幅

               PSMCT32                         2 PIXELの倍数
               PSMCT24                         8 PIXELの倍数
               PSMCT16, 16S                    4 PIXELの倍数
               PSMT8, 8H, PSMT4, 4HH, 4HL      8 PIXELの倍数

    上記制約を満たさない転送が行われた場合、GS の不具合によりまれにデータ
    の一部が欠落した状態で転送が行われる場合があります。データが欠落した
    部分は、以前書きこまれていたデータがそのまま残っている状態になり、
    データ欠落部分以降のデータについては転送位置のずれは発生しません。

    [回避策]
    GS ローカルメモリーへのテクスチャ転送時には、必ず上記制限を満たす形で
    実行して下さい。

